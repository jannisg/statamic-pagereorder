/*!
 * Statamic: Page Reorder
 * https://github.com/jannisg/statamic-pagereorder
 *
 * Build: 0.3.0 (2015-01-10)
 *
 * Copyright (c) 2015 Jannis Gundermann (http://jannisgundermann.com)
 * Released under the MIT license.
 */
/*
 * HTML5 Sortable jQuery Plugin
 * http://farhadi.ir/projects/html5sortable
 *
 * Copyright 2012, Ali Farhadi
 * @license: Released under the MIT license.
 */
(function(t){var e,r=t();t.fn.sortable=function(s){var n=s+"";return s=t.extend({connectWith:!1},s),this.each(function(){if(/^enable|disable|destroy$/.test(n)){var i=t(this).children(t(this).data("items")).attr("draggable","enable"==n);return"destroy"==n&&i.add(this).removeData("connectWith items").off("dragstart.h5s dragend.h5s selectstart.h5s dragover.h5s dragenter.h5s drop.h5s"),void 0}var a,o,i=t(this).children(s.items),d=t("<"+(/^ul|ol$/i.test(this.tagName)?"li":"div")+' class="sortable-placeholder">');i.find(s.handle).mousedown(function(){a=!0}).mouseup(function(){a=!1}),t(this).data("items",s.items),r=r.add(d),s.connectWith&&t(s.connectWith).add(this).data("connectWith",s.connectWith),i.attr("draggable","true").on("dragstart.h5s",function(r){if(s.handle&&!a)return!1;a=!1;var n=r.originalEvent.dataTransfer;n.effectAllowed="move",n.setData("Text","dummy"),o=(e=t(this)).addClass("sortable-dragging").index()}).on("dragend.h5s",function(){e&&(e.removeClass("sortable-dragging").show(),r.detach(),o!=e.index()&&e.parent().trigger("sortupdate",{item:e}),e=null)}).not("a[href], img").on("selectstart.h5s",function(){return this.dragDrop&&this.dragDrop(),!1}).end().add([this,d]).on("dragover.h5s dragenter.h5s drop.h5s",function(n){return i.is(e)||s.connectWith===t(e).parent().data("connectWith")?"drop"==n.type?(n.stopPropagation(),r.filter(":visible").after(e),e.trigger("dragend.h5s"),!1):(n.preventDefault(),n.originalEvent.dataTransfer.dropEffect="move",i.is(this)?(s.forcePlaceholderSize&&d.height(e.outerHeight()),e.hide(),t(this)[d.index()<t(this).index()?"after":"before"](d),r.not(d).detach()):r.is(this)||t(this).children(s.items).length||(r.detach(),t(this).append(d)),!1):!0})})}})(jQuery);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var s in e)__hasProp.call(e,s)&&(t[s]=e[s]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};window.DEBUG===void 0&&(window.DEBUG=!0),function(t){var e,r,s,n,i,a,o,d,l,h,u,p,c,g,f,v,m,b,y;if(u="draggable"in document.createElement("span"),!u)return!1;for(s=function(){function e(){this.tmpl={success:_.template('<div id="flash-msg" class="page-order__flash success">\n  <span class="icon page-order__flash-icon ss-check"></span>\n  <span class="msg page-order__flash-msg"><%= message %></p>\n</div>'),error:_.template('<div id="flash-msg" class="page-order__flash error">\n  <span class="icon page-order__flash-icon ss-alert"></span>\n  <span class="msg page-order__flash-msg"><%= message %></p>\n</div>')},this.container=t("#status-bar"),this.container.length&&this.bindEvents()}return e.prototype.bindEvents=function(){var e=this;return this.container.on("flash",function(r,s){var n,i,a;return i=50,t("#flash-msg").length&&(i=150,n=t("#flash-msg"),n.stop(!0).fadeOut(i,function(){return n.remove()})),a=e.tmpl[s.status]({message:s.message}),e.container.prepend(a),t("#flash-msg").delay(i).animate({"margin-top":"0"},900,"easeOutBounce").delay(3e3).animate({"margin-top":"-74px"},900,"easeInOutBack",function(){return t(this).remove()}),void 0})},e.prototype.trigger=function(t){return this.container.triggerHandler("flash",t)},e}(),r=t("#page-tree"),e=r.find(".subpages"),f={},g="page-order",l=""+g+"-active",c=""+g+"-ignore",h=""+g+"-sortable",p='<div class="'+g+'">\n  <div class="'+g+'__block">\n    <div class="'+g+'__icon">&#11021;</div>\n  </div>\n</div>',i=function(){function e(e,r,s){this.list=e,this.itemSelector=r,this.options=s,this.options=t.extend({},f,this.options),this.API_URL="/TRIGGER/pagereorder/"+this.API_KEYWORD,this.children=this.list.children(),this.subs=this.list.find(".subpages"),this.source=this.list.html(),null!=this.list&&null!=this.itemSelector&&null!=this.API_URL&&this.bootstrap()}return e.prototype.bootstrap=function(){var e,r,s,n,i,a,o;for(a=this.children,n=0,i=a.length;i>n;n++)r=a[n],e=t(r),s=e.find(".page-delete").length,s?(e.addClass(h),null!=(o=e.find("> .page-wrapper"))&&o.prepend(p)):e.addClass(c);return this.init()},e.prototype.init=function(){return this.$sortable=this.list.sortable({items:"."+this.itemSelector,handle:"> .page-wrapper > .page-order > ."+g+"__block"}),this.bindEvents()},e.prototype.reset=function(){return this.list.html(this.source),null!=this.$sortable&&this.$sortable.sortable("destroy"),this.init()},e.prototype.bindEvents=function(){var t=this;return this.$sortable.on({dragstart:function(e){return e.stopPropagation(),t.list.addClass(l),null!=t.subs&&t.subs.slideUp({duration:350,easing:"easeInExpo"}),t.source=t.list.html()},dragend:function(e){return e.stopPropagation(),t.list.removeClass(l),null!=t.subs?t.subs.slideDown({duration:700,easing:"easeOutExpo"}):void 0}})},e.prototype.send=function(){var e,r=this;return null!=this.order?(e=t.post(this.API_URL,{order:JSON.stringify(this.order)}),e.done(function(e){var n,i,a,o,d,l,h,u,p,c,g,f,v,m,_,b;if(e=JSON.parse(e),s.trigger({status:e.status,message:e.message}),"success"===e.status&&null!=e.linkage)for(l=e.linkage,g=0,m=l.length;m>g;g++)if(d=l[g],d.old!==d["new"]){for(a=r.list.find("a[href*='"+d.old+"']"),f=0,_=a.length;_>f;f++)i=a[f],i.href=i.href.replace(""+d.old,""+d["new"]);for(c=RegExp(""+d.old,"gi"),p=r.list.find("[data-path*='"+d.old+"']"),v=0,b=p.length;b>v;v++)o=p[v],n=t(o),u=n.data("path"),c.test(u)&&(h=u.replace(""+d.old,""+d["new"]),n.attr("data-path",h))}return"error"===e.status?r.reset():void 0}),e.fail(function(t){return s.trigger({status:"error",message:"There was an error saving your page order. Please try again."}),r.reset()}),e.always(function(){return r.order=void 0})):void 0},e}(),o=function(e){function r(){this.API_KEYWORD="reorder",r.__super__.constructor.apply(this,arguments)}return __extends(r,e),r.prototype.bindEvents=function(){var e=this;return this.$sortable.on({sortupdate:function(r){var s,n,i;return r.stopPropagation(),i=t(r.currentTarget).find("> .page"),e.order=function(){var e,r,a;for(a=[],e=0,r=i.length;r>e;e++)n=i[e],s=t(n),a.push({index:s.index(),url:t.trim(s.find(".slug-preview").first().text())});return a}(),e.send()}}),r.__super__.bindEvents.apply(this,arguments)},r}(i),a=function(e){function r(){this.API_KEYWORD="reordersubpages",r.__super__.constructor.apply(this,arguments)}return __extends(r,e),r.prototype.bindEvents=function(){var e=this;return this.$sortable.on({sortupdate:function(r){var s,n,i;return r.stopPropagation(),i=t(r.currentTarget).find("> .page"),e.order=function(){var e,r,a;for(a=[],e=0,r=i.length;r>e;e++)n=i[e],s=t(n),a.push({index:s.index(),url:t.trim(s.find(".slug-preview").first().text())});return a}(),e.send()}}),r.__super__.bindEvents.apply(this,arguments)},r}(i),s=new s,n=new o(r,h),d=[],y=[],m=0,b=e.length;b>m;m++)v=e[m],y.push(d.push(new a(t(v),h)));return y}(jQuery);