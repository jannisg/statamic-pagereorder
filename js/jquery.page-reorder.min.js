/*!
 * Statamic: Page Reorder
 * https://github.com/jannisg/statamic-pagereorder
 *
 * Build: 0.2.0 (2015-01-09)
 *
 * Copyright (c) 2015 Jannis Gundermann (http://jannisgundermann.com)
 * Released under the MIT license.
 */
/*
 * HTML5 Sortable jQuery Plugin
 * http://farhadi.ir/projects/html5sortable
 *
 * Copyright 2012, Ali Farhadi
 * @license: Released under the MIT license.
 */
(function(e){var t,r=e();e.fn.sortable=function(a){var n=a+"";return a=e.extend({connectWith:!1},a),this.each(function(){if(/^enable|disable|destroy$/.test(n)){var s=e(this).children(e(this).data("items")).attr("draggable","enable"==n);return"destroy"==n&&s.add(this).removeData("connectWith items").off("dragstart.h5s dragend.h5s selectstart.h5s dragover.h5s dragenter.h5s drop.h5s"),void 0}var i,d,s=e(this).children(a.items),o=e("<"+(/^ul|ol$/i.test(this.tagName)?"li":"div")+' class="sortable-placeholder">');s.find(a.handle).mousedown(function(){i=!0}).mouseup(function(){i=!1}),e(this).data("items",a.items),r=r.add(o),a.connectWith&&e(a.connectWith).add(this).data("connectWith",a.connectWith),s.attr("draggable","true").on("dragstart.h5s",function(r){if(a.handle&&!i)return!1;i=!1;var n=r.originalEvent.dataTransfer;n.effectAllowed="move",n.setData("Text","dummy"),d=(t=e(this)).addClass("sortable-dragging").index()}).on("dragend.h5s",function(){t&&(t.removeClass("sortable-dragging").show(),r.detach(),d!=t.index()&&t.parent().trigger("sortupdate",{item:t}),t=null)}).not("a[href], img").on("selectstart.h5s",function(){return this.dragDrop&&this.dragDrop(),!1}).end().add([this,o]).on("dragover.h5s dragenter.h5s drop.h5s",function(n){return s.is(t)||a.connectWith===e(t).parent().data("connectWith")?"drop"==n.type?(n.stopPropagation(),r.filter(":visible").after(t),t.trigger("dragend.h5s"),!1):(n.preventDefault(),n.originalEvent.dataTransfer.dropEffect="move",s.is(this)?(a.forcePlaceholderSize&&o.height(t.outerHeight()),t.hide(),e(this)[o.index()<e(this).index()?"after":"before"](o),r.not(o).detach()):r.is(this)||e(this).children(a.items).length||(r.detach(),e(this).append(o)),!1):!0})})}})(jQuery),$(function(){var e,t,r,a,n,s,i,d,o,l,h,c,g,u;return(d="draggable"in document.createElement("span"))?(i={success:_.template('<div id="flash-msg" class="page-order__flash success">\n  <span class="icon page-order__flash-icon ss-check"></span>\n  <span class="msg page-order__flash-msg"><%= message %></p>\n</div>'),error:_.template('<div id="flash-msg" class="page-order__flash error">\n  <span class="icon page-order__flash-icon ss-alert"></span>\n  <span class="msg page-order__flash-msg"><%= message %></p>\n</div>')},e=$("#status-bar"),e.on("flash",function(t,r){var a,n,s;return n=50,$("#flash-msg").length&&(n=150,a=$("#flash-msg"),a.stop(!0).fadeOut(n,function(){return a.remove()})),s=i[r.status]({message:r.message}),e.prepend(s),$("#flash-msg").delay(n).animate({"margin-top":"0"},900,"easeOutBounce").delay(3e3).animate({"margin-top":"-74px"},900,"easeInOutBack",function(){return $(this).remove()}),void 0}),a=$("#page-tree"),r=a.find(".subpages"),c="page-order",n=""+c+"-active",l=""+c+"-ignore",s=""+c+"-sortable",o='<div class="'+c+'">\n  <div class="'+c+'__block">\n    <div class="'+c+'__icon">&#11021;</div>\n  </div>\n</div>',a.children().each(function(){var e,t,r;return e=$(this),t=e.find(".page-delete").length,t?(e.addClass(s),null!=(r=e.find("> .page-wrapper"))?r.prepend(o):void 0):e.addClass(l)}),u="",t=null,(h=function(){return t=$("#page-tree").sortable({items:"."+s,handle:"."+c+"__block"})})(),g=function(){return a.html(u),t.sortable("destroy"),h()},t.on({dragstart:function(){return a.addClass(n),r.slideUp({duration:350,easing:"easeInExpo"}),u=a.html()},dragend:function(){return a.removeClass(n),r.slideDown({duration:700,easing:"easeOutExpo"})},sortupdate:function(){var t,r,n,s,i,d;return i=$(this).find("> .page"),r=function(){var e,r,a;for(a=[],e=0,r=i.length;r>e;e++)s=i[e],t=$(s),a.push({index:t.index(),url:$.trim(t.find(".slug-preview").first().text())});return a}(),n=JSON.stringify(r),d="/TRIGGER/pagereorder/reorder",$.ajax(d,{type:"POST",data:{order:n},complete:function(t){var r,n,s,i,d,o,l,h,c;if(t.responseText&&(d=$.parseJSON(t.responseText)),e.triggerHandler("flash",d),"success"===d.status&&null!=d.linkage)for(i=d.linkage,o=0,h=i.length;h>o;o++)if(s=i[o],s.old!==s["new"])for(n=a.find("a[href*='"+s.old+"']"),l=0,c=n.length;c>l;l++)r=n[l],r.href=r.href.replace(""+s.old,""+s["new"]);return"error"===d.status?g():void 0},error:function(){return e.triggerHandler("flash",{status:"error",message:"There was an error saving your page order. Please try again."}),g()}}),void 0}})):!1});