/*!
 * Statamic: Page Reorder
 * https://github.com/jannisg/statamic-pagereorder
 *
 * Build: 0.2.0 (2015-01-10)
 *
 * Copyright (c) 2015 Jannis Gundermann (http://jannisgundermann.com)
 * Released under the MIT license.
 */
/*
 * HTML5 Sortable jQuery Plugin
 * http://farhadi.ir/projects/html5sortable
 *
 * Copyright 2012, Ali Farhadi
 * @license: Released under the MIT license.
 */
(function(e){var t,r=e();e.fn.sortable=function(s){var n=s+"";return s=e.extend({connectWith:!1},s),this.each(function(){if(/^enable|disable|destroy$/.test(n)){var o=e(this).children(e(this).data("items")).attr("draggable","enable"==n);return"destroy"==n&&o.add(this).removeData("connectWith items").off("dragstart.h5s dragend.h5s selectstart.h5s dragover.h5s dragenter.h5s drop.h5s"),void 0}var i,a,o=e(this).children(s.items),d=e("<"+(/^ul|ol$/i.test(this.tagName)?"li":"div")+' class="sortable-placeholder">');o.find(s.handle).mousedown(function(){i=!0}).mouseup(function(){i=!1}),e(this).data("items",s.items),r=r.add(d),s.connectWith&&e(s.connectWith).add(this).data("connectWith",s.connectWith),o.attr("draggable","true").on("dragstart.h5s",function(r){if(s.handle&&!i)return!1;i=!1;var n=r.originalEvent.dataTransfer;n.effectAllowed="move",n.setData("Text","dummy"),a=(t=e(this)).addClass("sortable-dragging").index()}).on("dragend.h5s",function(){t&&(t.removeClass("sortable-dragging").show(),r.detach(),a!=t.index()&&t.parent().trigger("sortupdate",{item:t}),t=null)}).not("a[href], img").on("selectstart.h5s",function(){return this.dragDrop&&this.dragDrop(),!1}).end().add([this,d]).on("dragover.h5s dragenter.h5s drop.h5s",function(n){return o.is(t)||s.connectWith===e(t).parent().data("connectWith")?"drop"==n.type?(n.stopPropagation(),r.filter(":visible").after(t),t.trigger("dragend.h5s"),!1):(n.preventDefault(),n.originalEvent.dataTransfer.dropEffect="move",o.is(this)?(s.forcePlaceholderSize&&d.height(t.outerHeight()),t.hide(),e(this)[d.index()<e(this).index()?"after":"before"](d),r.not(d).detach()):r.is(this)||e(this).children(s.items).length||(r.detach(),e(this).append(d)),!1):!0})})}})(jQuery);var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var s in t)__hasProp.call(t,s)&&(e[s]=t[s]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};(function(e){var t,r,s,n,o,i,a,d,l,h,u,c,p,g,f,v,m,b,y;if(u="draggable"in document.createElement("span"),!u)return!1;for(s=function(){function t(){this.tmpl={success:_.template('<div id="flash-msg" class="page-order__flash success">\n  <span class="icon page-order__flash-icon ss-check"></span>\n  <span class="msg page-order__flash-msg"><%= message %></p>\n</div>'),error:_.template('<div id="flash-msg" class="page-order__flash error">\n  <span class="icon page-order__flash-icon ss-alert"></span>\n  <span class="msg page-order__flash-msg"><%= message %></p>\n</div>')},this.container=e("#status-bar"),console.log("Flash :: @container",this.container),this.container.length&&this.bindEvents()}return t.prototype.bindEvents=function(){var t=this;return console.log("Flash :: bindEvents"),this.container.on("flash",function(r,s){var n,o,i;return o=50,e("#flash-msg").length&&(o=150,n=e("#flash-msg"),n.stop(!0).fadeOut(o,function(){return n.remove()})),i=t.tmpl[s.status]({message:s.message}),t.container.prepend(i),e("#flash-msg").delay(o).animate({"margin-top":"0"},900,"easeOutBounce").delay(3e3).animate({"margin-top":"-74px"},900,"easeInOutBack",function(){return e(this).remove()}),void 0})},t.prototype.trigger=function(e){return console.log("Flash :: trigger",e),this.container.triggerHandler("flash",e)},t}(),r=e("#page-tree"),t=r.find(".subpages"),f={},g="page-order",l=""+g+"-active",p=""+g+"-ignore",h=""+g+"-sortable",c='<div class="'+g+'">\n  <div class="'+g+'__block">\n    <div class="'+g+'__icon">&#11021;</div>\n  </div>\n</div>',o=function(){function t(t,r,s){this.list=t,this.itemSelector=r,this.options=s,this.options=e.extend({},f,this.options),this.API_URL="/TRIGGER/pagereorder/"+this.API_KEYWORD,this.children=this.list.children(),this.subs=this.list.find(".subpages"),this.source=this.list.html(),null!=this.list&&null!=this.itemSelector&&null!=this.API_URL&&this.bootstrap()}return t.prototype.bootstrap=function(){var t,r,s,n,o,i,a;for(console.log("Reorder :: bootstrap"),i=this.children,n=0,o=i.length;o>n;n++)r=i[n],t=e(r),s=t.find(".page-delete").length,s?(t.addClass(h),null!=(a=t.find("> .page-wrapper"))&&a.prepend(c)):t.addClass(p);return this.init()},t.prototype.init=function(){return console.log("Reorder :: init"),this.$sortable=this.list.sortable({items:"."+this.itemSelector,handle:"> .page-wrapper > .page-order > ."+g+"__block"}),console.log("Reorder :: @$sortable =",this.$sortable),this.bindEvents()},t.prototype.reset=function(){return console.log("Reorder :: reset"),this.list.html(this.source),null!=this.$sortable&&this.$sortable.sortable("destroy"),this.init()},t.prototype.bindEvents=function(){var e=this;return console.log("Reorder :: bindEvents"),this.$sortable.on({dragstart:function(t){return console.log("Reorder :: bindEvents :: dragstart"),t.stopPropagation(),e.list.addClass(l),console.log("Reorder :: bindEvents :: dragstart :: @subs",e.subs),null!=e.subs&&e.subs.slideUp({duration:350,easing:"easeInExpo"}),e.source=e.list.html()},dragend:function(t){return console.log("Reorder :: bindEvents :: dragend"),t.stopPropagation(),e.list.removeClass(l),null!=e.subs?e.subs.slideDown({duration:700,easing:"easeOutExpo"}):void 0}})},t.prototype.send=function(){var t,r=this;return console.log("Reorder :: send"),null!=this.order?(t=e.post(this.API_URL,{order:JSON.stringify(this.order)}),t.done(function(t){var n,o,i,a,d,l,h,u,c,p,g,f,v,m,b,_;if(console.log("Reorder :: send :: request.done",t),t=JSON.parse(t),s.trigger({status:t.status,message:t.message}),"success"===t.status&&null!=t.linkage)for(l=t.linkage,g=0,m=l.length;m>g;g++)if(d=l[g],d.old!==d["new"]){for(i=r.list.find("a[href*='"+d.old+"']"),f=0,b=i.length;b>f;f++)o=i[f],o.href=o.href.replace(""+d.old,""+d["new"]);for(p=RegExp(""+d.old,"gi"),c=r.list.find("[data-path*='"+d.old+"']"),v=0,_=c.length;_>v;v++)a=c[v],n=e(a),u=n.data("path"),p.test(u)&&(h=u.replace(""+d.old,""+d["new"]),n.attr("data-path",h))}return"error"===t.status?r.reset():void 0}),t.fail(function(e){return console.log("Reorder :: send :: request.fail",e),s.trigger({status:"error",message:"There was an error saving your page order. Please try again."}),r.reset()}),t.always(function(){return r.order=void 0})):void 0},t}(),a=function(t){function r(){this.API_KEYWORD="reorder",r.__super__.constructor.apply(this,arguments)}return __extends(r,t),r.prototype.bindEvents=function(){var t=this;return console.log("ReorderTopLevel :: bindEvents"),this.$sortable.on({sortupdate:function(r){var s,n,o;return console.log("ReorderTopLevel :: sortupdate"),r.stopPropagation(),o=e(r.currentTarget).find("> .page"),t.order=function(){var t,r,i;for(i=[],t=0,r=o.length;r>t;t++)n=o[t],s=e(n),i.push({index:s.index(),url:e.trim(s.find(".slug-preview").first().text())});return i}(),t.send()}}),r.__super__.bindEvents.apply(this,arguments)},r}(o),i=function(t){function r(){this.API_KEYWORD="reordersubpages",r.__super__.constructor.apply(this,arguments)}return __extends(r,t),r.prototype.bindEvents=function(){var t=this;return console.log("ReorderSubpages :: bindEvents"),this.$sortable.on({sortupdate:function(r){var s,n,o;return console.log("ReorderSubpages :: sortupdate"),r.stopPropagation(),o=e(r.currentTarget).find("> .page"),t.order=function(){var t,r,i;for(i=[],t=0,r=o.length;r>t;t++)n=o[t],s=e(n),i.push({index:s.index(),url:e.trim(s.find(".slug-preview").first().text())});return i}(),console.log("ReorderSubpages :: sortupdate :: order",t.order),t.send()}}),r.__super__.bindEvents.apply(this,arguments)},r}(o),s=new s,n=new a(r,h),d=[],y=[],m=0,b=t.length;b>m;m++)v=t[m],y.push(d.push(new i(e(v),h)));return y})(jQuery);